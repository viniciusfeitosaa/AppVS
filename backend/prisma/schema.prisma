// Prisma Schema para App Médico
// Banco de dados: PostgreSQL (externo ao Docker)

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  MASTER
  MEDICO
}

model Tenant {
  id        String   @id @default(uuid())
  nome      String   @db.VarChar(120)
  slug      String   @unique @db.VarChar(80)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  medicos        Medico[]
  usuariosMaster UsuarioMaster[]

  @@map("tenants")
  @@index([slug])
}

model UsuarioMaster {
  id        String   @id @default(uuid())
  tenantId  String   @map("tenant_id")
  nome      String   @db.VarChar(255)
  email     String   @db.VarChar(255)
  senhaHash String   @map("senha_hash") @db.VarChar(255)
  role      UserRole @default(MASTER)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessoes      SessaoMaster[]
  auditoriaLog Auditoria[]   @relation("auditoria_master")

  @@map("usuarios_master")
  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
}

// Modelo de Médico
model Medico {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  cpf           String   @db.VarChar(11) // CPF sem formatação (11 dígitos)
  crm           String   @db.VarChar(20) // Ex: "12345-SP"
  nomeCompleto  String   @db.VarChar(255)
  email         String?  @db.VarChar(255)
  senhaHash     String   @db.VarChar(255) // Hash bcrypt
  especialidade String?  @db.VarChar(100)
  vinculo       String?  @db.VarChar(20)   // Ex: "PJ" ou vazio (Associado)
  telefone      String?  @db.VarChar(20)
  ativo         Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relações
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessoes       Sessao[]
  auditoria     Auditoria[]

  @@map("medicos")
  @@unique([tenantId, cpf])
  @@unique([tenantId, crm])
  @@unique([tenantId, email])
  @@index([tenantId, cpf])
  @@index([tenantId, crm])
  @@index([tenantId, email])
}

// Modelo de Sessão (Tokens JWT)
model Sessao {
  id        String   @id @default(uuid())
  medicoId  String   @map("medico_id")
  tokenHash String   @db.VarChar(255) // Hash do refresh token
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  ipAddress String?  @map("ip_address") @db.VarChar(45) // IPv4 ou IPv6
  userAgent String?  @map("user_agent") @db.Text

  // Relação
  medico Medico @relation(fields: [medicoId], references: [id], onDelete: Cascade)

  @@map("sessoes")
  @@index([medicoId])
  @@index([expiresAt])
}

model SessaoMaster {
  id        String   @id @default(uuid())
  masterId  String   @map("master_id")
  tokenHash String   @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text

  master UsuarioMaster @relation(fields: [masterId], references: [id], onDelete: Cascade)

  @@map("sessoes_master")
  @@index([masterId])
  @@index([expiresAt])
}

// Modelo de Auditoria (Logs de ações)
model Auditoria {
  id        String   @id @default(uuid())
  medicoId  String?  @map("medico_id") // Null se ação não autenticada
  masterId  String?  @map("master_id")
  acao      String   @db.VarChar(100) // Ex: "LOGIN", "LOGOUT", "ACESSO_DASHBOARD"
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.Text
  detalhes  Json?    // Dados adicionais em JSON
  createdAt DateTime @default(now()) @map("created_at")

  // Relação
  medico Medico?        @relation(fields: [medicoId], references: [id], onDelete: SetNull)
  master UsuarioMaster? @relation("auditoria_master", fields: [masterId], references: [id], onDelete: SetNull)

  @@map("auditoria")
  @@index([medicoId])
  @@index([masterId])
  @@index([acao])
  @@index([createdAt])
}
